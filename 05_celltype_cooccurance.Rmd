---
title: "Cell type co-occurrence"
output:
  html_document:
    toc: true
    df_print: paged
---


**Are myeloid cells migrating closer to the epithelia in Crohn's disease?**


We can use spicyR to test if there is a change in the relative closeness of different cell types (e.g. myeloid and epithelia) across different conditions.

See: [spicyR vignette](https://www.bioconductor.org/packages/release/bioc/vignettes/spicyR/inst/doc/spicyR.html#41_Test_for_change_in_localisation_for_a_specific_pair_of_cells)



# Build the input table for spicyR


SpicyR can work with a `SpatialFeatureExperiment` object, but not in this specific case (it lacks image data, and some coordinates are negative). So instead, we will build a table of the relevant input data.

For every cell, it requires the following:

* Cell type
* X and Y coordinates
* Sample ID 
* Sample condition 
* Field of view (FOV) (optional)


The centroid coordinates of each cell are stored in the `spatialCoords` component of the `SpatialFeatureExperiment` object, accessed using the `spatialCoords()` function.

```{r}
head(spatialCoords(sfe))
```

Everything else we need is stored in the `colData` component of the `SpatialFeatureExperiment` object. We can join those two tables together, and then rename some columns according to what spicyR expects.

```{r}
# epi => myeloid
spicy_cell_info <- as.data.frame(colData(sfe))[,c('cell', 'tissue_sample',  'celltype_subset', 'group', 'fov_name') ]
spicy_cell_info <- cbind(spicy_cell_info, spatialCoords(sfe))
spicy_cell_info <- spicy_cell_info %>%
  dplyr::rename(
    imageID = fov_name, #there are 4 fovs per tissue sample. In Xenium data, that would be one per slide. And in other experiments, many samples per image.
    x=CenterX_global_px,
    y=CenterY_global_px
  )
spicy_cell_info$imageID <- droplevels(spicy_cell_info$imageID)

```


If any of the x or y coordinates are negative, offset all x or y values by 1 to ensure all values are positive. Absolute positions of the cells don't matter, just the relative position between cells.

```{r}
# remove negative values - not supported by spicyR
# Else yields error: Error in owinInternalRect(xrange, yrange, ..., unitname = unitname): xrange should be a vector of length 2 giving (xmin, xmax)
min_x <- min(spicy_cell_info$x)
min_y <- min(spicy_cell_info$y)
if (min_x < 0) {spicy_cell_info$x = spicy_cell_info$x + -(min_x) + 1 }
if (min_y < 0) {spicy_cell_info$y = spicy_cell_info$y + -(min_y) + 1 }
```

## Test proximity of myeloid cells to epithelia

Call the `spicy()` function to perform tests comparing cell types by condition. 

The `sigma` value is a variable used for scaling when tissue types are inhomogenous. More information on selecting a `sigma` value can be found in the [spicyR vingette](https://bioconductor.org/packages/release/bioc/vignettes/spicyR/inst/doc/spicyR.html#7_Accounting_for_tissue_inhomogeneity) and [spicyWorkflow vignette](https://www.bioconductor.org/packages/release/workflows/vignettes/spicyWorkflow/inst/doc/spicyWorkflow.html#14_spicyR:_Test_spatial_relationships).

```{r}
spicy_res <- spicy(
  cells     = spicy_cell_info , 
  subject   = 'tissue_sample',
  cellType  = 'celltype_subset',
  sigma     = 50,
  condition = "group",
  from      = "epi",
  to        = "myeloids"
)
```


NB: Garrido-Trigo et al did a detailed exploration of localisation of macrophage and neutrophil subtypes in their data. We are testing a toy subset with some very broad cell types!


```{r}
topPairs(spicy_res)
```

We can plot the 'L-function' between these groups per condition. There is an L value for each sample, which represents the 'closeness' of the cell type pair in that sample. Higher values indicates co-localisation. 

```{r}
spicyBoxPlot(spicy_res, 
             from = "epi", 
             to = "myeloids")
```


## Tests for changes across all cell types


If we omit the pair of cell types - all combinations will be tested.
```{r}
spicy_res <- spicy(
  cells     = spicy_cell_info , 
  subject   = 'tissue_sample',
  cellType  = 'celltype_subset',
  sigma     = 50, # tissue is not homogeneous see: https://www.bioconductor.org/packages/release/workflows/vignettes/spicyWorkflow/inst/doc/spicyWorkflow.html#14_spicyR:_Test_spatial_relationships
  condition = "group"
)

```

And there is a very nice visualisation. The size of the circle scales with significance, and the colour indicates the magnitude of the 'L' Value. 

```{r}
signifPlot(spicy_res)
```


We should interpret this carefully (especially for such a small dataset) - is it actually interesting biology?

```{r}
p1 <- plotSpatialFeature(sfe.sample.HC, "celltype_subset",colGeometryName = "cellSeg") + 
  theme(legend.title=element_blank()) +
  ggtitle(sample)

p2 <- plotSpatialFeature(sfe.sample.CD,  "celltype_subset", colGeometryName = "cellSeg") + 
  theme(legend.title=element_blank()) +
  ggtitle(sample)

p1 / p2 

```

